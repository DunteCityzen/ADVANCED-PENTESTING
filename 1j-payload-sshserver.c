#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <libssh/libssh.h>

#define UNUSED(x) (void)(x)

int authenticate_password(const char *username, const char *password) {
    // Check if the username and password match the expected values
    if (strcmp(username, "testuser") == 0 && strcmp(password, "testpasswd") == 0) {
        return 1; // Authentication successful
    }
    return 0; // Authentication failed
}

int main() {
    ssh_bind sshbind;
    ssh_session session;
    int rc;

    // Create a new SSH server instance
    sshbind = ssh_bind_new();
    if (sshbind == NULL) {
        fprintf(stderr, "Error creating SSH bind\n");
        exit(EXIT_FAILURE);
    }

    // Set options for the SSH server
    rc = ssh_bind_options_set(sshbind, SSH_BIND_OPTIONS_BINDPORT_STR, "2222"); // Use non-standard port 2222
    if (rc != SSH_OK) {
        fprintf(stderr, "Error setting bind options: %s\n", ssh_get_error(sshbind));
        exit(EXIT_FAILURE);
    }

    // Start listening for incoming connections
    rc = ssh_bind_listen(sshbind);
    if (rc != SSH_OK) {
        fprintf(stderr, "Error listening on SSH socket: %s\n", ssh_get_error(sshbind));
        exit(EXIT_FAILURE);
    }

    printf("SSH server listening on port 2222...\n");

    // Accept incoming connections and handle them
    while (1) {
        session = ssh_new();
        if (session == NULL) {
            fprintf(stderr, "Error creating SSH session\n");
            exit(EXIT_FAILURE);
        }

        rc = ssh_bind_accept(sshbind, session);
        if (rc != SSH_OK) {
            fprintf(stderr, "Error accepting SSH connection: %s\n", ssh_get_error(sshbind));
            exit(EXIT_FAILURE);
        }

        // Authenticate the user using password authentication
        rc = ssh_handle_key_exchange(session);
        if (rc != SSH_OK) {
            fprintf(stderr, "Error handling SSH key exchange: %s\n", ssh_get_error(session));
            exit(EXIT_FAILURE);
        }

        char *username = ssh_userauth_kbdint_getprompt(session, 0, NULL);
        char *password = ssh_userauth_kbdint_getanswer(session, 0);
        if (authenticate_password(username, password)) {
            printf("User '%s' authenticated successfully\n", username);
            ssh_userauth_kbdint_setanswer(session, 0, "testpasswd");
        } else {
            printf("Authentication failed for user '%s'\n", username);
            ssh_userauth_kbdint_setanswer(session, 0, "");
        }
        ssh_string_free_char(username);
        ssh_string_free_char(password);

        // Close the SSH session
        ssh_disconnect(session);
        ssh_free(session);
    }

    // Stop listening and clean up
    ssh_bind_free(sshbind);
    return 0;
}

// Compile with -> gcc -o ssh_server ssh_server.c -lssh